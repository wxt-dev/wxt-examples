<!-- Generated by scripts/generate-diffs.ts -->

# IndexedDB

> Based off the [`vanilla`](https://github.com/wxt-dev/wxt/tree/main/templates/vanilla) template.
>
> ```sh
> npx wxt@latest init --template vanilla
> ```

If you need to store an unknown amount of data, IndexedDB is the only solution for web extensions. It has no storage size limits, and provides fast ways to query the data.

However, just like `localStorage`, `sessionStorage`, and other standard web storage solutions, an extension does not share IndexedDB instances across all contexts. The popup, content scripts, options page, and background all have separate databases.

So when using IndexedDB in web extensions, it's important to always access it from the background. Then you can use the background as if it's a standard backend, making requests to it for data.

In this example, we're going to use [`idb`](https://www.npmjs.com/package/idb) to simplify the IndexedDB code, and [`@webext-core/proxy-service`](https://webext-core.aklinker1.io/guide/proxy-service/) to simplify the communication with the background.

###### package.json

```diff
@@ -14,8 +14,12 @@
     "compile": "tsc --noEmit",
     "postinstall": "wxt prepare"
   },
   "devDependencies": {
     "typescript": "^5.1.6",
     "wxt": "^0.10.0"
+  },
+  "dependencies": {
+    "@webext-core/proxy-service": "^1.2.0",
+    "idb": "^7.1.1"
   }
 }
```

First, we need to setup our database.

###### utils/idb.ts

```ts
import { IDBPDatabase, openDB } from 'idb';

export function openExtensionDatabase(): Promise<IDBPDatabase> {
  return openDB('todos', 1, {
    upgrade(database) {
      database.createObjectStore('todos', { keyPath: 'id' });
    },
  });
}
```

We also need to setup a service for interacting with our database.

###### utils/todos-repo.ts

```ts
import { defineProxyService } from '@webext-core/proxy-service';
import { IDBPDatabase } from 'idb';

export interface Todo {
  id: string;
  title: string;
  done?: boolean;
}

export interface TodosRepo {
  createOrUpdate(todo: Todo): Promise<void>;
  delete(todo: Todo): Promise<void>;
  getOne(id: Todo['id']): Promise<Todo>;
  getAll(): Promise<Todo[]>;
}

function createTodosRepo(db: Promise<IDBPDatabase>): TodosRepo {
  return {
    async createOrUpdate(todo) {
      await (await db).put('todos', todo);
    },
    async delete(todo) {
      await (await db).delete('todos', todo.id);
    },
    async getOne(id) {
      return await (await db).get('todos', id);
    },
    async getAll() {
      return await (await db).getAll('todos');
    },
  };
}

export const [registerTodosRepo, getTodosRepo] = defineProxyService(
  'todos-repo',
  createTodosRepo,
);
```

In the background, we can open our database, register the proxy service, and start using the repo!

###### entrypoints/background.ts

```diff
@@ -1,3 +1,12 @@
 export default defineBackground(() => {
   console.log('Hello background!', { id: browser.runtime.id });
+
+  const idb = openExtensionDatabase();
+  const todosRepo = registerTodosRepo(idb);
+
+  void todosRepo.getAll().then(console.log);
+  void todosRepo.createOrUpdate({
+    id: '1',
+    title: 'Example todo',
+  });
 });
```

In the popup, use `getTodosRepo` to get an instance of `TodosRepo` that executes in the background.

###### entrypoints/popup/main.ts

```diff
@@ -19,6 +19,18 @@ document.querySelector<HTMLDivElement>('#app')!.innerHTML = `
       Click on the WXT and TypeScript logos to learn more
     </p>
   </div>
 `;

 setupCounter(document.querySelector<HTMLButtonElement>('#counter')!);
+
+const todosRepo = getTodosRepo();
+
+(async () => {
+  todosRepo.createOrUpdate({
+    id: '2',
+    title: 'Another TODO',
+  });
+
+  const all = await todosRepo.getAll();
+  console.log('All todos:', all);
+})();
```
